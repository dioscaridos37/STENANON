<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–ùO–ù–ò–ú–ù–ê–Ø –°–¢–ïN–ê (Firebase)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // ‚ö†Ô∏è –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–ò –ö–õ–Æ–ß–ò –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE
        const firebaseConfig = {
           apiKey: "AIzaSyC3JH8ZcIFLNb0SsmwB9kYBDEMt1lsVgRM",
           authDomain: "huega-chat.firebaseapp.com",
           projectId: "huega-chat",
           storageBucket: "huega-chat.firebasestorage.app",
           messagingSenderId: "509304723720",
           appId: "1:509304723720:web:e566cfe1368285941ff4bd",
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const postsCollection = db.collection('anonWallPosts');

        // --- –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï –î–õ–Ø ID ---
        const USER_ID = localStorage.getItem('anonUserId') || (Math.random().toString(36).substring(2, 9));
        localStorage.setItem('anonUserId', USER_ID);

        // üîë –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
        // ‚ö†Ô∏è –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® –°–ö–û–ü–ò–†–û–í–ê–ù–ù–´–ô ID
        const ADMIN_USER_ID = "YOUR_ADMIN_ID_HERE"; 
        const IS_ADMIN = (USER_ID === ADMIN_USER_ID);
    </script>

    <style>
        /* ==================================== */
        /* CSS –°–¢–ò–õ–ò: –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π            */
        /* ==================================== */
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 5px rgba(0, 198, 255, 0.5), 0 0 10px rgba(0, 198, 255, 0.3); }
            50% { transform: scale(1.03); box-shadow: 0 0 10px rgba(0, 198, 255, 0.8), 0 0 20px rgba(0, 198, 255, 0.6); }
            100% { transform: scale(1); box-shadow: 0 0 5px rgba(0, 198, 255, 0.5), 0 0 10px rgba(0, 198, 255, 0.3); }
        }
        
        @keyframes newPostFlash {
            0%, 100% { border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 0 5px rgba(0, 198, 255, 0.5), 0 0 10px rgba(0, 198, 255, 0.3); }
            50% { border-color: #00ff00; box-shadow: 0 0 20px #00ff00, 0 0 40px rgba(0, 255, 0, 0.5); }
        }

        body {
            background: radial-gradient(circle at 50% 10%, #0c0033 0%, #000000 100%);
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: hidden;
        }

        .anon-wall {
            width: 100vw;
            height: 100vh;
            position: relative; 
            overflow: hidden; 
        }

        header {
            width: 100%;
            position: fixed; 
            top: 0;
            left: 0;
            z-index: 1001; 
        }
        
        header h1 {
            font-size: 3em;
            letter-spacing: 5px;
            padding-top: 20px;
            margin: 0; 
            text-align: center;
        }

        .controls-container {
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls-container::before {
            content: '';
            position: absolute;
            width: 300px; 
            height: 300px;
            border: 2px dashed rgba(0, 198, 255, 0.3);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
        }

        .filter-button {
            position: fixed; 
            padding: 10px 15px;
            background: rgba(0, 198, 255, 0.3);
            color: #ffffff;
            border: 1px solid #00c6ff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            z-index: 1002; 
        }

        #top-10-button { top: 20px; right: 20px; }
        #my-posts-button { top: 20px; left: 20px; }
        .active-filter { background: #ff69b4 !important; border: 1px solid #ff69b4 !important; }

        .input-container {
            display: flex;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 30px;
            padding: 5px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 350px;
            margin-top: 20px;
        }

        .input-container input {
            flex-grow: 1;
            background: transparent;
            border: none;
            padding: 15px 20px;
            color: #ffffff;
            font-size: 1.1em;
            outline: none;
        }
        
        .send-button {
            background: linear-gradient(45deg, #007bff, #00c6ff);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .send-button svg { color: #ffffff; transform: translate(2px, 0); }

        .posts-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 300vw; 
            height: 300vh;
            cursor: grab; 
            will-change: transform; 
            transform: translate(-100vw, -100vh); 
            transform-origin: 50% 50%;
            z-index: 1; 
        }
        
        .posts-grid.is-dragging { cursor: grabbing; }

        .post {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            padding: 15px 25px;
            border-radius: 20px;
            min-width: 200px;
            max-width: 250px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 5px rgba(0, 198, 255, 0.5), 0 0 10px rgba(0, 198, 255, 0.3);
            transition: opacity 0.5s, transform 0.5s, left 0.5s, top 0.5s, border-color 0.5s;
            z-index: 50; 
            margin-left: -125px; 
            margin-top: -100px; 
        }
        
        .post.new-post { animation: newPostFlash 0.2s 10 alternate; }
        .post-hidden { opacity: 0 !important; pointer-events: none; }
        .post.top-post { animation: pulse 2s ease-in-out infinite; }
        
        .delete-button { position: absolute; top: 5px; right: 5px; background: none; border: none; color: rgba(255, 255, 255, 0.5); font-size: 1.2em; cursor: pointer; transition: color 0.2s; line-height: 1; padding: 5px; z-index: 60; }
        .delete-button:hover { color: #ff0000; }
        
        .post-footer { display: flex; align-items: center; font-size: 0.9em; color: rgba(255, 255, 255, 0.7); }
        .votes { color: #00c6ff; margin-right: 15px; cursor: pointer; transition: all 0.2s; }
        .likes { color: #ff69b4; cursor: pointer; transition: all 0.2s; }
        .voted { cursor: default !important; opacity: 0.8; font-weight: bold; }

        /* =========================================== */
        /* üìå –°–¢–ò–õ–ò –î–õ–Ø –ó–ê–ö–†–ï–ü–õ–ï–ù–ù–´–• –ü–û–°–¢–û–í –ò –ê–î–ú–ò–ù–ê  */
        /* =========================================== */

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ */
        .post.pinned {
            border: 3px solid #ffcc00; 
            box-shadow: 0 0 15px #ffcc00, 0 0 30px rgba(255, 204, 0, 0.5);
            background: rgba(255, 204, 0, 0.15); 
            z-index: 55 !important; 
        }

        /* –ú–µ—Ç–∫–∞ "–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ" */
        .pin-label {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffcc00;
            color: #333;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
            z-index: 50;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ê–¥–º–∏–Ω–∞ */
        .admin-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            z-index: 60;
        }

        .admin-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 5px;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            transition: background 0.2s, border-color 0.2s;
        }

        .admin-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .delete-button.admin-action-btn {
            color: #ff0000;
        }

        .pin-button {
            color: #ffcc00;
        }

        .pin-button.unpin {
            background: #ffcc00;
            color: #333;
            border-color: #ffcc00;
        }

        /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å admin-controls */
        .post .delete-button:not(.admin-action-btn) { 
            top: 35px;
            right: 5px;
            position: absolute;
        }
    </style>
</head>
<body>
    <div class="anon-wall">
        <header>
            <h1>–°–¢–ïN–ê –ê–ùO–ù–ò–ú</h1>
        </header>

        <div class="controls-container">
            <div class="input-container">
                <input type="text" id="post-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∞–Ω–æ–Ω–∏–º–æ–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="send-button" id="send-button">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M2.01 21L23 12 2.01 3v7l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>

        <button class="filter-button" id="my-posts-button">–¢–í–û–ò –ü–û–°–¢–´</button>
        <button class="filter-button" id="top-10-button">–¢–û–ü-10 –ê–ü–í–û–£–¢–û–í</button>
        
        <div class="posts-grid" id="posts-container">
            </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputField = document.getElementById('post-input');
            const sendButton = document.getElementById('send-button');
            const postsContainer = document.getElementById('posts-container');
            const top10Button = document.getElementById('top-10-button');
            const myPostsButton = document.getElementById('my-posts-button');
            
            // --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
            const CANVAS_SIZE_VW = 300; 
            const MAX_RADIUS = 120; 
            const POST_SPACING = 20; 
            const MIN_RADIUS_OFFSET = 15; 
            
            const CENTER_X = CANVAS_SIZE_VW / 2;
            const CENTER_Y = CANVAS_SIZE_VW / 2; 
            
            let postsData = []; // –î–∞–Ω–Ω—ã–µ —Ç–µ–ø–µ—Ä—å –±–µ—Ä—É—Ç—Å—è –∏–∑ Firestore
            let postIdCounter = 0; 
            let currentFilter = 'all'; 

            // ===============================================
            // –§–£–ù–ö–¶–ò–ò FIREBASE
            // ===============================================

            /** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ—Å—Ç –≤ Firestore. */
            async function savePostToFirestore(post) {
                try {
                    await postsCollection.doc(String(post.id)).set(post);
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞ –≤ Firestore: ", e);
                }
            }

            /** –£–¥–∞–ª—è–µ—Ç –ø–æ—Å—Ç –∏–∑ Firestore. */
            async function deletePostFromFirestore(postId) {
                 if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) {
                    try {
                        await postsCollection.doc(String(postId)).delete();
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞ –∏–∑ Firestore: ", e);
                    }
                }
            }
            
            /** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è Firestore. –û–±–Ω–æ–≤–ª—è–µ—Ç postsData –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Å—Ç–µ–Ω—É. */
            function initFirestoreListener() {
                postsCollection.onSnapshot(snapshot => {
                    postsData = [];
                    let maxId = 0;
                    
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        postsData.push(post);
                        if (post.id > maxId) {
                            maxId = post.id;
                        }
                    });
                    
                    postIdCounter = maxId;

                    // *** –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –°–û–†–¢–ò–†–û–í–ö–ò: –°–Ω–∞—á–∞–ª–∞ Pinned, –ø–æ—Ç–æ–º –ø–æ ID (–¥–ª—è —Å–ø–∏—Ä–∞–ª–∏) ***
                    postsData.sort((a, b) => {
                        // 1. –°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö isPinned: true
                        if (a.isPinned && !b.isPinned) return -1;
                        if (!a.isPinned && b.isPinned) return 1;
                        
                        // 2. –ó–∞—Ç–µ–º –ø–æ ID (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º) –¥–ª—è —Å–ø–∏—Ä–∞–ª—å–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                        return b.id - a.id; 
                    });
                    // **************************************************************************
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏/–∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                    updateAllPostPositions();
                    
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å—Ç–µ–Ω—É
                    renderPosts();
                }, error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö Firestore: ", error);
                });
            }

            // ===============================================
            // –§–£–ù–ö–¶–ò–ò –°–ü–ò–†–ê–õ–¨–ù–û–ì–û –ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–Ø –ò –°–û–†–¢–ò–†–û–í–ö–ò (–û—Å—Ç–∞–ª–∏—Å—å –ø—Ä–µ–∂–Ω–∏–º–∏)
            // ===============================================
            function calculateSpiralPositions(data) {
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ id –∫ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º –∏–ª–∏ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º
                const sortedPosts = [...data].sort((a, b) => b.id - a.id);
                
                return sortedPosts.map((post, index) => {
                    const postOrder = index + 1; 
                    
                    let radius = MIN_RADIUS_OFFSET + Math.sqrt(postOrder) * POST_SPACING; 
                    const angle = postOrder * (137.5 * (Math.PI / 180)); 

                    if (radius > MAX_RADIUS) {
                        radius = MAX_RADIUS;
                    }

                    const xOffset = radius * Math.cos(angle);
                    const yOffset = radius * Math.sin(angle);

                    return {
                        id: post.id,
                        position: {
                            left: CENTER_X + xOffset,
                            top: CENTER_Y + yOffset
                        }
                    };
                });
            }

            function updateAllPostPositions() {
                // –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Firestore, –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º postsData, –∞ –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ savePostToFirestore()
                const newPositions = calculateSpiralPositions(postsData);
                newPositions.forEach(newPos => {
                    const post = postsData.find(p => p.id === newPos.id);
                    if (post) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ
                        post.position = newPos.position;
                    }
                });
            }

            function sortPostsData(data) {
                return data.sort((a, b) => {
                    if (a.votes !== b.votes) {
                        return b.votes - a.votes; 
                    }
                    return b.id - a.id; 
                });
            }

            // ===============================================
            // –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ü–û–°–¢–û–í –ù–ê –•–û–õ–°–¢–ï
            // ===============================================
            function renderPosts() {
                let postsToDisplay = [];
                let temporaryPositions = {}; 

                if (currentFilter === 'mine') {
                    postsToDisplay = postsData.filter(p => p.userId === USER_ID);
                    const tempPos = calculateSpiralPositions(postsToDisplay);
                    tempPos.forEach(p => temporaryPositions[p.id] = p.position);

                } else if (currentFilter === 'top10') {
                    postsToDisplay = sortPostsData([...postsData]).slice(0, 10);
                    const tempPos = calculateSpiralPositions(postsToDisplay);
                    tempPos.forEach(p => temporaryPositions[p.id] = p.position);
                    
                } else { // 'all'
                    postsToDisplay = postsData;
                }
                
                const displayIds = new Set(postsToDisplay.map(p => p.id));
                
                // 1. –°–æ–∑–¥–∞–Ω–∏–µ/–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/–°–∫—Ä—ã—Ç–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                postsData.forEach(postData => {
                    let postElement = document.querySelector(`.post[data-post-id="${postData.id}"]`);
                    let isVisible = displayIds.has(postData.id);

                    if (!postElement) {
                        postElement = createPostElementDOM(postData);
                        postsContainer.appendChild(postElement);
                    } else {
                         // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–≥–æ–ª–æ—Å–∞, –ª–∞–π–∫–∏, –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ)
                         postElement.querySelector('.votes').textContent = `‚¨Ü ${postData.votes}`;
                         postElement.querySelector('.likes').textContent = `‚ô° ${postData.likes}`;
                         if (postData.likedBy && postData.likedBy[USER_ID]) {
                            postElement.querySelector('.likes').textContent = `‚ô• ${postData.likes}`;
                         } else {
                            postElement.querySelector('.likes').textContent = `‚ô° ${postData.likes}`;
                         }
                         if (postData.votedBy && postData.votedBy[USER_ID]) {
                            postElement.querySelector('.votes').classList.add('voted');
                         } else {
                             postElement.querySelector('.votes').classList.remove('voted');
                         }
                         
                         // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è,
                         // —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—ã–ª–∏ –≤–∏–¥–Ω—ã –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω.
                         if (IS_ADMIN) {
                            const pinBtn = postElement.querySelector('.pin-button');
                            if (pinBtn) {
                                pinBtn.textContent = postData.isPinned ? 'üîì' : 'üìå';
                                pinBtn.title = postData.isPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
                                pinBtn.classList.toggle('unpin', postData.isPinned);
                            }
                         }

                         // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è
                         postElement.classList.toggle('pinned', postData.isPinned);
                         const pinLabel = postElement.querySelector('.pin-label');
                         if (postData.isPinned && !pinLabel) {
                            // –ï—Å–ª–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ, –Ω–æ –º–µ—Ç–∫–∏ –Ω–µ—Ç (–±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞/–Ω–µ —Å–æ–∑–¥–∞–Ω–∞)
                            const newPinLabel = document.createElement('div');
                            newPinLabel.className = 'pin-label';
                            newPinLabel.textContent = 'üìå –ó–ê–ö–†–ï–ü–õ–ï–ù–û';
                            postElement.prepend(newPinLabel);
                         } else if (!postData.isPinned && pinLabel) {
                            // –ï—Å–ª–∏ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ, –Ω–æ –º–µ—Ç–∫–∞ –µ—Å—Ç—å
                            pinLabel.remove();
                         }
                    }
                    
                    let pos = postData.position;
                    if (currentFilter !== 'all' && isVisible && temporaryPositions[postData.id]) {
                        pos = temporaryPositions[postData.id];
                    } 
                    
                    postElement.style.top = `${pos.top}vh`; 
                    postElement.style.left = `${pos.left}vw`;

                    if (isVisible) {
                        postElement.classList.remove('post-hidden');
                    } else {
                        postElement.classList.add('post-hidden');
                    }
                    
                    if (postData.votes >= 10) {
                        postElement.classList.add('top-post');
                    } else {
                        postElement.classList.remove('top-post');
                    }
                });
                
                // 2. –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                Array.from(postsContainer.children).forEach(el => {
                    const postId = parseInt(el.dataset.postId);
                    if (!postsData.some(p => p.id === postId)) {
                        el.remove();
                    }
                });

                // 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∫–Ω–æ–ø–æ–∫
                top10Button.classList.remove('active-filter');
                myPostsButton.classList.remove('active-filter');
                if (currentFilter === 'top10') {
                    top10Button.classList.add('active-filter');
                } else if (currentFilter === 'mine') {
                    myPostsButton.classList.add('active-filter');
                }
            }


            // ===============================================
            // –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ò–Ø DOM-–≠–õ–ï–ú–ï–ù–¢–ê –ü–û–°–¢–ê (–° –∫–Ω–æ–ø–∫–∞–º–∏ –ê–¥–º–∏–Ω–∞)
            // ===============================================
            function createPostElementDOM(postData) {
                const post = document.createElement('div');
                post.className = 'post';
                post.dataset.postId = postData.id;
                post.dataset.userId = postData.userId;
                
                // üìå –ï—Å–ª–∏ –ø–æ—Å—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∏ –º–µ—Ç–∫—É
                if (postData.isPinned) {
                    post.classList.add('pinned');
                    const pinLabel = document.createElement('div');
                    pinLabel.className = 'pin-label';
                    pinLabel.textContent = 'üìå –ó–ê–ö–†–ï–ü–õ–ï–ù–û';
                    post.prepend(pinLabel);
                }

                const text = document.createElement('p');
                text.textContent = postData.message;

                const footer = document.createElement('div');
                footer.className = 'post-footer';

                // ===========================================
                // üîë –ë–õ–û–ö –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê (–£–¥–∞–ª–µ–Ω–∏–µ + –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ)
                // ===========================================
                if (IS_ADMIN) {
                    const adminControls = document.createElement('div');
                    adminControls.className = 'admin-controls';
                    
                    // 1. –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-button admin-action-btn';
                    deleteBtn.textContent = '‚úñ';
                    deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç (–ê–¥–º–∏–Ω)';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        deletePostFromFirestore(postData.id);
                    });
                    
                    // 2. –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è
                    const pinBtn = document.createElement('button');
                    pinBtn.className = `pin-button admin-action-btn ${postData.isPinned ? 'unpin' : 'pin'}`;
                    pinBtn.textContent = postData.isPinned ? 'üîì' : 'üìå';
                    pinBtn.title = postData.isPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
                    pinBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ isPinned
                        const updatedPost = { ...postData, isPinned: !postData.isPinned };
                        savePostToFirestore(updatedPost);
                    });

                    adminControls.appendChild(pinBtn);
                    adminControls.appendChild(deleteBtn);
                    post.appendChild(adminControls);
                }
                // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∞ –ø–æ—Å—Ç–∞ (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
                else if (postData.userId === USER_ID) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-button';
                    deleteBtn.textContent = '‚úñ';
                    deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –º–æ–π –ø–æ—Å—Ç';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        deletePostFromFirestore(postData.id);
                    });
                    post.appendChild(deleteBtn);
                }


                const votesSpan = document.createElement('span');
                votesSpan.className = 'votes';
                votesSpan.textContent = `‚¨Ü ${postData.votes}`; 
                
                const likesSpan = document.createElement('span');
                likesSpan.className = 'likes';
                likesSpan.textContent = `‚ô° ${postData.likes}`;
                
                const alreadyVoted = postData.votedBy && postData.votedBy[USER_ID];
                const alreadyLiked = postData.likedBy && postData.likedBy[USER_ID];
                
                if (alreadyVoted) { votesSpan.classList.add('voted'); }
                if (alreadyLiked) {
                    likesSpan.textContent = `‚ô• ${postData.likes}`;
                    likesSpan.classList.add('voted');
                    likesSpan.style.color = '#ff99c8';
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–ø–≤–æ—É—Ç–∞
                votesSpan.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const postIndex = postsData.findIndex(p => p.id === postData.id);
                    if (postIndex !== -1 && (!postsData[postIndex].votedBy || !postsData[postIndex].votedBy[USER_ID])) {
                        // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é
                        const updatedPost = { ...postsData[postIndex] };
                        updatedPost.votes = (updatedPost.votes || 0) + 1;
                        updatedPost.votedBy = { ...(updatedPost.votedBy || {}), [USER_ID]: true };
                        
                        // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ Firestore
                        savePostToFirestore(updatedPost);
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ª–∞–π–∫–∞
                likesSpan.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const postIndex = postsData.findIndex(p => p.id === postData.id);
                    if (postIndex !== -1 && (!postsData[postIndex].likedBy || !postsData[postIndex].likedBy[USER_ID])) {
                        // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é
                        const updatedPost = { ...postsData[postIndex] };
                        updatedPost.likes = (updatedPost.likes || 0) + 1;
                        updatedPost.likedBy = { ...(updatedPost.likedBy || {}), [USER_ID]: true };
                        
                        // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ Firestore
                        savePostToFirestore(updatedPost);
                    }
                });

                footer.appendChild(votesSpan);
                footer.appendChild(likesSpan);
                post.appendChild(text);
                post.appendChild(footer);

                return post;
            }

            // ===============================================
            // –õ–û–ì–ò–ö–ê –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø –•–û–õ–°–¢–ê (PAN) (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            // ===============================================
            
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            postsContainer.addEventListener('mousedown', (e) => {
                if (e.target.closest('.post') || e.button !== 0) { 
                    return; 
                }
                
                isDragging = true;
                postsContainer.classList.add('is-dragging');
                
                const transformMatrix = window.getComputedStyle(postsContainer).transform;
                if (transformMatrix !== 'none') {
                    const matrix = transformMatrix.match(/matrix.*\((.+)\)/);
                    if (matrix && matrix[1]) {
                        const values = matrix[1].split(', ');
                        initialX = parseFloat(values[4] || 0);
                        initialY = parseFloat(values[5] || 0);
                    }
                } else {
                    initialX = -window.innerWidth; 
                    initialY = -window.innerHeight; 
                }
                
                startX = e.clientX;
                startY = e.clientY;
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault(); 
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                const newX = initialX + dx;
                const newY = initialY + dy;
                
                postsContainer.style.transform = `translate(${newX}px, ${newY}px)`;
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    postsContainer.classList.remove('is-dragging');
                }
            });

            // ===============================================
            // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–¢–ü–†–ê–í–ö–ò/–§–ò–õ–¨–¢–†–ê–¶–ò–ò
            // ===============================================
            
            function handleSend() {
                const message = inputField.value.trim();
                if (message) {
                    postIdCounter++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
                    const newPost = {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –¥–ª—è —Å–ø–∏—Ä–∞–ª–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                        id: postIdCounter, 
                        userId: USER_ID,
                        message: message,
                        votes: 0,
                        likes: 0,
                        votedBy: {},
                        likedBy: {},
                        position: { top: CENTER_Y, left: CENTER_X },
                        isPinned: false // <-- –ù–û–í–û–ï –ü–û–õ–ï
                    };
                    
                    savePostToFirestore(newPost);
                    
                    inputField.value = '';
                    currentFilter = 'all'; 
                }
            }

            sendButton.addEventListener('click', handleSend);
            inputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSend();
                }
            });
            
            top10Button.addEventListener('click', () => {
                currentFilter = currentFilter === 'top10' ? 'all' : 'top10';
                renderPosts();
            });

            myPostsButton.addEventListener('click', () => {
                currentFilter = currentFilter === 'mine' ? 'all' : 'mine';
                renderPosts();
            });
            
            // --- –ì–õ–ê–í–ù–´–ô –ó–ê–ü–£–°–ö ---
            initFirestoreListener(); 
        });
    </script>
</body>
</html>
