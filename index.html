<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–ï–ù–¢–ê –ê–ù–û–ù–ò–ú–û–í (Firebase Feed)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // ‚ö†Ô∏è –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–ò –ö–õ–Æ–ß–ò –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE
        const firebaseConfig = {
           apiKey: "AIzaSyC3JH8ZcIFLNb0SsmwB9kYBDEMt1lsVgRM",
           authDomain: "huega-chat.firebaseapp.com",
           projectId: "huega-chat",
           storageBucket: "huega-chat.firebasestorage.app",
           messagingSenderId: "509304723720",
           appId: "1:509304723720:web:e566cfe1368285941ff4bd",
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const postsCollection = db.collection('anonWallPosts');

        // --- –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï –î–õ–Ø ID ---
        const USER_ID = localStorage.getItem('anonUserId') || (Math.random().toString(36).substring(2, 9));
        localStorage.setItem('anonUserId', USER_ID);

        // üîë –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
        // ‚ö†Ô∏è –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® –°–ö–û–ü–ò–†–û–í–ê–ù–ù–´–ô ID
        const ADMIN_USER_ID = "xesws6b"; 
        const IS_ADMIN = (USER_ID === ADMIN_USER_ID);
    </script>

    <link rel="stylesheet" href="styles.css"> 
    <style> 
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –º–∞–∫–µ—Ç—É */
        @keyframes newPostFlash {
            0%, 100% { border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 0 5px rgba(0, 198, 255, 0.5), 0 0 10px rgba(0, 198, 255, 0.3); }
            50% { border-color: #00ff00; box-shadow: 0 0 20px #00ff00, 0 0 40px rgba(0, 255, 0, 0.5); }
        }
        .post.new-post { animation: newPostFlash 0.2s 10 alternate; }
        
        /* =========================================== */
        /* üìå –°–¢–ò–õ–ò –î–õ–Ø –ó–ê–ö–†–ï–ü–õ–ï–ù–ù–´–• –ü–û–°–¢–û–í –ò –ê–î–ú–ò–ù–ê  */
        /* (–î–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏)         */
        /* =========================================== */

        .post.pinned {
            border: 3px solid #ffcc00; 
            box-shadow: 0 0 15px #ffcc00, 0 0 30px rgba(255, 204, 0, 0.5);
            background: rgba(255, 204, 0, 0.15); 
        }

        .pin-label {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffcc00;
            color: #333;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
            z-index: 50;
        }

        .admin-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            z-index: 60;
        }

        .admin-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 5px;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            transition: background 0.2s, border-color 0.2s;
        }

        .admin-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .delete-button.admin-action-btn {
            color: #ff0000;
        }

        .pin-button {
            color: #ffcc00;
        }

        .pin-button.unpin {
            background: #ffcc00;
            color: #333;
            border-color: #ffcc00;
        }
        
        /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å admin-controls */
        .post .delete-button:not(.admin-action-btn) { 
            top: 35px;
            right: 5px;
            position: absolute;
        }
    </style>
</head>
<body>
    <div class="anon-wall-feed">
        <header>
            <h1>–õ–ï–ù–¢–ê –ê–ù–û–ù–ò–ú–ù–´–• –ú–´–°–õ–ï–ô</h1>
        </header>

        <main class="feed-layout">
            <div class="main-feed">
                <div class="feed-controls">
                    <button class="filter-button" id="my-posts-button">–¢–í–û–ò –ü–û–°–¢–´</button>
                    <button class="filter-button" id="all-posts-button">–í–°–ï –ü–û–°–¢–´</button>
                </div>
                <div id="posts-container" class="posts-list">
                    </div>
            </div>

            <aside class="top-posts-sidebar">
                <h2>üèÜ –¢–û–ü-10 –ê–ü–í–û–£–¢–û–í</h2>
                <div id="top-posts-container">
                    </div>
            </aside>
        </main>

        <div class="input-container-footer">
            <input type="text" id="post-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∞–Ω–æ–Ω–∏–º–æ–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="send-button" id="send-button">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M2.01 21L23 12 2.01 3v7l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputField = document.getElementById('post-input');
            const sendButton = document.getElementById('send-button');
            const mainPostsContainer = document.getElementById('posts-container');
            const topPostsContainer = document.getElementById('top-posts-container');
            const myPostsButton = document.getElementById('my-posts-button');
            const allPostsButton = document.getElementById('all-posts-button');
            
            let postsData = []; 
            let postIdCounter = 0; 
            let currentFilter = 'all'; 

            // ===============================================
            // –§–£–ù–ö–¶–ò–ò FIREBASE
            // ===============================================

            async function savePostToFirestore(post) {
                try {
                    // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                    post.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await postsCollection.doc(String(post.id)).set(post);
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞ –≤ Firestore: ", e);
                }
            }

            async function deletePostFromFirestore(postId) {
                 if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) {
                    try {
                        await postsCollection.doc(String(postId)).delete();
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞ –∏–∑ Firestore: ", e);
                    }
                }
            }
            
            /** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è Firestore. –û–±–Ω–æ–≤–ª—è–µ—Ç postsData –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –ª–µ–Ω—Ç—É. */
            function initFirestoreListener() {
                // –í–ê–ñ–ù–û: –ú—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º orderBy('id', 'desc') –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å 
                // –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –ø–æ isPinned, –∞ –ø–æ—Ç–æ–º –ø–æ id.
                postsCollection.onSnapshot(snapshot => {
                    postsData = [];
                    let maxId = 0;
                    
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        postsData.push(post);
                        if (post.id > maxId) {
                            maxId = post.id;
                        }
                    });
                    
                    postIdCounter = maxId;

                    // *** –õ–û–ì–ò–ö–ê –°–û–†–¢–ò–†–û–í–ö–ò: –°–Ω–∞—á–∞–ª–∞ Pinned, –ø–æ—Ç–æ–º –ø–æ ID (–ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É) ***
                    postsData.sort((a, b) => {
                        // 1. –°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö isPinned: true
                        if (a.isPinned && !b.isPinned) return -1;
                        if (!a.isPinned && b.isPinned) return 1;
                        
                        // 2. –ó–∞—Ç–µ–º –ø–æ ID (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
                        return b.id - a.id; 
                    });
                    // ************************************************************

                    renderPosts(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ–±–µ —Å–µ–∫—Ü–∏–∏
                }, error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö Firestore: ", error);
                });
            }

            // ===============================================
            // –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ü–û–°–¢–û–í
            // ===============================================

            /** –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ—Å—Ç—ã –ø–æ –≥–æ–ª–æ—Å–∞–º –¥–ª—è –¢–û–ü-10 */
            function sortPostsByVotes(data) {
                return data.sort((a, b) => {
                    if (a.votes !== b.votes) {
                        return b.votes - a.votes; // –ü–æ —É–±—ã–≤–∞–Ω–∏—é –≥–æ–ª–æ—Å–æ–≤
                    }
                    return b.id - a.id; // –í—Ç–æ—Ä–∏—á–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ ID (–Ω–æ–≤—ã–µ)
                });
            }

            function renderPosts() {
                // --- 1. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ì–õ–ê–í–ù–û–ô –õ–ï–ù–¢–´ ---
                let mainFeedData = [];
                if (currentFilter === 'mine') {
                    mainFeedData = postsData.filter(p => p.userId === USER_ID);
                    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ ID –æ—Å—Ç–∞–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ postsData —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞
                } else { 
                    mainFeedData = postsData; // postsData —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ Pinned/ID
                }
                
                // –û—á–∏—Å—Ç–∫–∞ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                mainPostsContainer.innerHTML = '';
                mainFeedData.forEach(postData => {
                    const postElement = createPostElementDOM(postData);
                    mainPostsContainer.appendChild(postElement);
                });
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∫–Ω–æ–ø–æ–∫
                myPostsButton.classList.toggle('active-filter', currentFilter === 'mine');
                allPostsButton.classList.toggle('active-filter', currentFilter === 'all');

                // --- 2. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¢–û–ü-10 –ö–û–õ–û–ù–ö–ò ---
                // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≥–æ–ª–æ—Å–∞–º, –±–µ—Ä–µ–º –¢–û–ü-10
                const top10Data = sortPostsByVotes([...postsData]).slice(0, 10);

                topPostsContainer.innerHTML = '';
                top10Data.forEach(postData => {
                    const postElement = createPostElementDOM(postData);
                    postElement.classList.add('top-sidebar-post'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
                    topPostsContainer.appendChild(postElement);
                });
            }


            // ===============================================
            // –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ò–Ø DOM-–≠–õ–ï–ú–ï–ù–¢–ê –ü–û–°–¢–ê (–° –∫–Ω–æ–ø–∫–∞–º–∏ –ê–¥–º–∏–Ω–∞)
            // ===============================================
            function createPostElementDOM(postData) {
                const post = document.createElement('div');
                post.className = 'post';
                post.dataset.postId = postData.id;
                post.dataset.userId = postData.userId;
                
                // üìå –ï—Å–ª–∏ –ø–æ—Å—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∏ –º–µ—Ç–∫—É
                if (postData.isPinned) {
                    post.classList.add('pinned');
                    const pinLabel = document.createElement('div');
                    pinLabel.className = 'pin-label';
                    pinLabel.textContent = 'üìå –ó–ê–ö–†–ï–ü–õ–ï–ù–û';
                    post.prepend(pinLabel);
                }
                
                const text = document.createElement('p');
                text.textContent = postData.message;

                const footer = document.createElement('div');
                footer.className = 'post-footer';

                // ===========================================
                // üîë –ë–õ–û–ö –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê (–£–¥–∞–ª–µ–Ω–∏–µ + –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ)
                // ===========================================
                if (IS_ADMIN) {
                    const adminControls = document.createElement('div');
                    adminControls.className = 'admin-controls';
                    
                    // 1. –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-button admin-action-btn';
                    deleteBtn.textContent = '‚úñ';
                    deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç (–ê–¥–º–∏–Ω)';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        deletePostFromFirestore(postData.id);
                    });
                    
                    // 2. –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è
                    const pinBtn = document.createElement('button');
                    pinBtn.className = `pin-button admin-action-btn ${postData.isPinned ? 'unpin' : 'pin'}`;
                    pinBtn.textContent = postData.isPinned ? 'üîì' : 'üìå';
                    pinBtn.title = postData.isPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
                    pinBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ isPinned
                        const updatedPost = { ...postData, isPinned: !postData.isPinned };
                        savePostToFirestore(updatedPost);
                    });

                    adminControls.appendChild(pinBtn);
                    adminControls.appendChild(deleteBtn);
                    post.appendChild(adminControls);
                }
                // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∞ –ø–æ—Å—Ç–∞ (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
                else if (postData.userId === USER_ID) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-button';
                    deleteBtn.textContent = '‚úñ';
                    deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –º–æ–π –ø–æ—Å—Ç';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        deletePostFromFirestore(postData.id);
                    });
                    // –í–∞–∂–Ω–æ: –ö–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∞ –∏ –∞–¥–º–∏–Ω–∞ –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ –∫–ª–∞—Å—Å—ã, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å–æ —Å—Ç–∏–ª—è–º–∏
                    post.appendChild(deleteBtn);
                }

                const votesSpan = document.createElement('span');
                votesSpan.className = 'votes';
                votesSpan.textContent = `‚¨Ü ${postData.votes}`; 
                
                const likesSpan = document.createElement('span');
                likesSpan.className = 'likes';
                likesSpan.textContent = `‚ô° ${postData.likes}`;
                
                const alreadyVoted = postData.votedBy && postData.votedBy[USER_ID];
                const alreadyLiked = postData.likedBy && postData.likedBy[USER_ID];
                
                if (alreadyVoted) { votesSpan.classList.add('voted'); }
                if (alreadyLiked) {
                    likesSpan.textContent = `‚ô• ${postData.likes}`;
                    likesSpan.classList.add('voted');
                    likesSpan.style.color = '#ff99c8';
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ (–∞–ø–≤–æ—É—Ç/–ª–∞–π–∫)
                votesSpan.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const postIndex = postsData.findIndex(p => p.id === postData.id);
                    if (postIndex !== -1 && (!postsData[postIndex].votedBy || !postsData[postIndex].votedBy[USER_ID])) {
                        const updatedPost = { ...postsData[postIndex] };
                        updatedPost.votes = (updatedPost.votes || 0) + 1;
                        updatedPost.votedBy = { ...(updatedPost.votedBy || {}), [USER_ID]: true };
                        savePostToFirestore(updatedPost);
                    }
                });
                
                likesSpan.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const postIndex = postsData.findIndex(p => p.id === postData.id);
                    if (postIndex !== -1 && (!postsData[postIndex].likedBy || !postsData[postIndex].likedBy[USER_ID])) {
                        const updatedPost = { ...postsData[postIndex] };
                        updatedPost.likes = (updatedPost.likes || 0) + 1;
                        updatedPost.likedBy = { ...(updatedPost.likedBy || {}), [USER_ID]: true };
                        savePostToFirestore(updatedPost);
                    }
                });

                footer.appendChild(votesSpan);
                footer.appendChild(likesSpan);
                post.appendChild(text);
                post.appendChild(footer);

                return post;
            }

            // ===============================================
            // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–¢–ü–†–ê–í–ö–ò/–§–ò–õ–¨–¢–†–ê–¶–ò–ò
            // ===============================================
            
            function handleSend() {
                const message = inputField.value.trim();
                if (message) {
                    postIdCounter++; 
                    const newPost = {
                        id: postIdCounter, 
                        userId: USER_ID,
                        message: message,
                        votes: 0,
                        likes: 0,
                        votedBy: {},
                        likedBy: {},
                        isPinned: false, // <-- –î–æ–±–∞–≤–ª–µ–Ω–æ
                    };
                    
                    savePostToFirestore(newPost);
                    inputField.value = '';
                    currentFilter = 'all'; 
                }
            }

            sendButton.addEventListener('click', handleSend);
            inputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSend();
                }
            });
            
            // –§–∏–ª—å—Ç—Ä –¢–≤–æ–∏ –ø–æ—Å—Ç—ã
            myPostsButton.addEventListener('click', () => {
                currentFilter = currentFilter === 'mine' ? 'all' : 'mine';
                renderPosts();
            });

            // –§–∏–ª—å—Ç—Ä –í—Å–µ –ø–æ—Å—Ç—ã
            allPostsButton.addEventListener('click', () => {
                currentFilter = 'all';
                renderPosts();
            });
            
            // --- –ì–õ–ê–í–ù–´–ô –ó–ê–ü–£–°–ö ---
            initFirestoreListener(); 
        });
    </script>
</body>
</html>
